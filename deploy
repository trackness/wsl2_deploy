#! /usr/bin/bash

# Correct starting directory in Windows Terminal settings
#	- add "startingDirectory": "//wsl$/Ubuntu/home/james/"

set_correct_working_dir() {
	# echo -n "Setting working directory to script location.. "
	SOURCE="${BASH_SOURCE[0]}"
	while [[ -h "$SOURCE" ]]; do
		DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
		SOURCE="$(readlink "$SOURCE")"
		[[ ${SOURCE} != /* ]] && SOURCE="$DIR/$SOURCE"
	done
	DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
	# echo "Done: ${DIR}"
}

update_distro() {
	message="Modernising distribution.."
	echo -ne "${message} |····················| [   0% ]\r"
	sudo apt-get -qq update -y > /dev/null 2>&1
	echo -ne "${message} |>>>>················| [  20% ]\r"
	sudo apt-get -qq upgrade -y > /dev/null 2>&1
	echo -ne "${message} |>>>>>>>>············| [  40% ]\r"
	sudo apt-get -qq dist-upgrade -y > /dev/null 2>&1
	echo -ne "${message} |>>>>>>>>>>>>········| [  60% ]\r"
	sudo apt-get -qq autoremove > /dev/null 2>&1
	echo -ne "${message} |>>>>>>>>>>>>>>>>····| [  80% ]\r"
	sudo apt-get -qq install git-all wget curl -y > /dev/null 2>&1
	echo -ne "${message} |>>>>>>>>>>>>>>>>>>>>| [ 100% ]\r"
	echo "${message} Done."
}

install_zsh() {
	echo -n "Installing ZSH.."
	sudo apt-get -qq install zsh -y  > /dev/null 2>&1
	echo "Done."
	echo -n "Installing Oh-My-Zsh.. "
	sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended > /dev/null 2>&1
	echo "Done."
	echo -n "Changing default shell to ZSH.. "
	sudo chsh -s $(which zsh) > /dev/null 2>&1
	echo "Done: $(which zsh)"
	echo -n "Installing Powerlevel10k.. "
	git clone --depth=1 https://github.com/romkatv/powerlevel10k.git ${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}/themes/powerlevel10k > /dev/null 2>&1
	echo "Done."
}

echo -n "Removing need for sudo password.. "
sudo echo "${USER} ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/${USER} > /dev/null 2>&1
echo "Done."

set_correct_working_dir
update_distro
install_zsh

echo -n "Copying config files.. "
cp ${DIR}/.zshrc ${HOME}
cp ${DIR}/.p10k.zsh ${HOME}
echo "Done."

echo -n "Setting git config.. "
git config --global user.email "40263851+trackness@users.noreply.github.com"
git config --global user.name "Trackness"
git config --global credential.helper "/mnt/c/Program\ Files/Git/mingw64/libexec/git-core/git-credential-manager.exe"
echo "Done."

echo -n "Installing Go.. "
sudo add-apt-repository -y ppa:longsleep/golang-backports > /dev/null 2>&1
sudo apt -qq -y update > /dev/null 2>&1
sudo apt -qq -y install golang-go > /dev/null 2>&1
echo "Done."

echo -n "Installing tfswitch.. "
curl -fsSL https://raw.githubusercontent.com/warrensbox/terraform-switcher/release/install.sh | bash > /dev/null 2>&1
echo "Done."

echo -n "Installing pyenv.. "
curl -fsSL https://pyenv.run | bash > /dev/null 2>&1
echo "export PATH=\"/home/${USER}/.pyenv/bin:"'$PATH"' >> ${HOME}/.zshrc
echo 'eval "$(pyenv init -)"' >> ${HOME}/.zshrc
echo 'eval "$(pyenv virtualenv-init -)"' >> ${HOME}/.zshrc
echo "Done."
echo -n "Setting global Python version.."
pyenv install 3.9.0 > /dev/null 2>&1
echo "Done."

echo -n "Installing Poetry.. "
curl -fsSL https://raw.githubusercontent.com/python-poetry/poetry/master/get-poetry.py | python - > /dev/null 2>&1
echo "Done."

# # VS Code Server
# code

exec zsh