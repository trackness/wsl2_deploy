#!/usr/bin/env bash

function wsl2_config() {
	sudo echo "${USER} ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/"${USER}" > /dev/null 2>&1
	echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf > /dev/null # WSL2 DNS bug workaround: https://github.com/microsoft/WSL/issues/5256#issuecomment-711459592
}

function log_and_exec() {
	local super=""
	local volume=1

	for arg in "$@"
	do
		case $arg in
			-su|--super)
				super="sudo "
				shift
				;;
			-q|--quiet)
				volume=-0
				shift
				;;
			-v|--verbose)
				volume=2
				shift
				;;
			-vv|--very-verbose)
				volume=3
				shift
				;;
		esac
	done

	if [[ $global_volume != "" ]]; then
		volume=$global_volume
	fi

    local message="${1}"
    local arr="$2"

	case $volume in
		0)
			if [[ $super ]]; then
				sudo bash -c "$arr" > /dev/null  2>&1
			else
				bash -c "$arr" > /dev/null 2>&1
			fi
			;;
		1)
			echo -n "### ${message}.. "
			# printf "### %-30s : %4d\n" "string 1" 12 "string 2" 122
			if [[ $super ]]; then
				sudo bash -c "$arr" > /dev/null 2>&1
			else
				# printf "${arr}"
				bash -c "$arr" > /dev/null 2>&1
			fi
			echo "Done."
			;;
		2)
			echo -n "### ${message}.. "
			if [[ $super ]]; then
				sudo bash -c "$arr" > /dev/null
			else
				bash -c "$arr" > /dev/null
			fi
			echo "Done."
			;;
		3)
			echo "### $message ###"
			if [[ $super ]]; then
				echo "$arr"
				sudo bash -c "$arr"
			else
				echo "$arr"
				bash -c "$arr"
			fi
			;;
	esac
}

function get_property {
	PROP_FILE=$1
	PROP_KEY=$2
	PROP_VALUE=$(grep "$PROP_KEY" "$PROP_FILE" | cut -d '=' -f2)
	shopt -s extglob
	output="${PROP_VALUE##*( )}"
	shopt -u extglob
	echo "$output"
}

function git_config() {
	log_and_exec "Setting Github name" "git config --global user.name $(get_property "/mnt/c/Users/James/.gitconfig" "name")"
	log_and_exec "Setting Github email" "git config --global user.email $(get_property "/mnt/c/Users/James/.gitconfig" "email")"
	log_and_exec "Setting Github credential manager" 'git config --global credential.helper "/mnt/c/Program\ Files/Git/mingw64/libexec/git-core/git-credential-manager.exe"'
}

function update_distro() {
	log_and_exec -su "Updating package index" "apt-get update -y"
	log_and_exec -su "Upgrading packages" "apt-get dist-upgrade -y"
	log_and_exec -su "Installing basic packages" "apt-get install git wget curl -y"
	log_and_exec -su "Removing unneccessary dependencies" "apt-get autoremove"
}

function update_shell() {
	# _zsh_install=()
	log_and_exec -su "Installing ZSH" "apt-get install zsh -y"

	# _oh_my_zsh=()
	log_and_exec "Installing Oh-My-Zsh" 'curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh "" --unattended'

	# _powerlevel10k=(git clone --depth=1 https://github.com/romkatv/powerlevel10k.git "${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}"/themes/powerlevel10k)
	log_and_exec "Installing Powerlevel10k" "git clone --depth=1 https://github.com/romkatv/powerlevel10k.git ${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}/themes/powerlevel10k"

	# _copy_zshrc=(sh -c "$(curl -fsSL https://raw.githubusercontent.com/trackness/wsl2_deploy/master/.zshrc -o ~/.zshrc)")
	log_and_exec "Copying .zshrc config" "curl -fsSL https://raw.githubusercontent.com/trackness/wsl2_deploy/master/.zshrc -o $HOME/.zshrc"

	# _copy_p10k=(sh -c "$(curl -fsSL https://raw.githubusercontent.com/trackness/wsl2_deploy/master/.p10k.zsh -o ~/.p10k.zsh)")
	log_and_exec "Copying .p10k.zsh config" "curl -fsSL https://raw.githubusercontent.com/trackness/wsl2_deploy/master/.p10k.zsh -o $HOME/.p10k.zsh"

	# _change_default_shell=(chsh -s /usr/bin/zsh "$USER")
	log_and_exec -su "Changing default shell to ZSH" "chsh -s /usr/bin/zsh $USER"
}

function install_dev_tools() {
	# _go_add=()
	# log_and_exec -su "Adding custom Go package source" "add-apt-repository -y ppa:longsleep/golang-backports"
	# _go_update=()
	# log_and_exec -su "Updating Go package index" "apt-get -y update"
	# _go_install=()
	log_and_exec -su "Installing Go" "apt-get -y install golang-go"

	# git clone https://github.com/udhos/update-golang
	# cd update-golang
	# sudo ./update-golang.sh

	# _tfswitch_install=(sh -c "$(curl -fsSL https://raw.githubusercontent.com/warrensbox/terraform-switcher/release/install.sh)")
	log_and_exec -su "Installing tfswitch" "curl -fsSL https://raw.githubusercontent.com/warrensbox/terraform-switcher/release/install.sh"
	# _tfswitch_terraform_0135=(tfswitch 0.13.5)
	log_and_exec -su "Setting terraform version" "tfswitch 0.13.5"

	# _pyenv_dependencies=(apt-get -y install --no-install-recommends make build-essential libssl-dev zlib1g-dev libbz2-dev libreadline-dev libsqlite3-dev wget curl libncurses5-dev xz-utils libxml2-dev libxmlsec1-dev libffi-dev liblzma-dev)
	log_and_exec -su "Installing pyenv dependencies" "apt-get -y install --no-install-recommends make build-essential libssl-dev zlib1g-dev libbz2-dev libreadline-dev libsqlite3-dev wget curl libncurses5-dev xz-utils libxml2-dev libxmlsec1-dev libffi-dev liblzma-dev"
	# _pyenv_path=(export PATH="$HOME"/.pyenv/bin:"$PATH")
	log_and_exec "Temporarily adding pyenv to path" "export PATH=$HOME/.pyenv/bin:$PATH"
	# _pyenv_install=(sh -c "$(curl -fsSL https://pyenv.run)")
	log_and_exec "Installing pyenv" "curl -fsSL https://pyenv.run"
	# _pyenv_eval_0=(eval "$(pyenv init -)")
	log_and_exec "Temporarily adding pyenv eval 0" "eval $(pyenv init -)"
	# _pyenv_eval_1=(eval "$(pyenv virtualenv-init -)")
	log_and_exec "Temporarily adding pyenv eval 1" "eval $(pyenv virtualenv-init -)"
	# _pyenv_python_390=(pyenv install 3.9.0)
	log_and_exec "Installing python 3.9.0" "pyenv install 3.9.0"
	# _pyenv_set_global=(pyenv global 3.9.0)
	log_and_exec "Setting global python to 3.9.0" "pyenv global 3.9.0"

	# _poetry_download=(curl -fsSL https://raw.githubusercontent.com/python-poetry/poetry/master/get-poetry.py -O)
	log_and_exec "Downloading Poetry" "curl -fsSL https://raw.githubusercontent.com/python-poetry/poetry/master/get-poetry.py -O"
	# _poetry_install=(python get-poetry.py -y)
	log_and_exec "Installing Poetry" "python get-poetry.py -y"
	# _poetry_clean=(mv get-poetry.py "$HOME"/.poetry)
	log_and_exec "Moving Poetry install script to ~/.poetry" "mv get-poetry.py $HOME/.poetry"

	if [[ $global_volume != "q" ]]; then
		printf '\n'
		echo 
		echo "### Dev Tool Versions ###"
		echo "tfswitch: $(tfswitch -v)"
		echo "terraform: $(terraform version)"
		echo "go: $(go version)"
		echo "pyenv: $(pyenv --version)"
		echo "python: $(python --version)"
	fi
}

function git_clone_all() {
	local code_dir=$1
	shift
	local targets=("${@}")
	for i in "${targets[@]}"
	do
		log_and_exec "Cloning repo to $1: $i" "git clone https://github.com/$i.git $1 --quiet"
	done
}

global_volume=""
code_dir="$HOME/code"

github_repos=(
	"trackness/wsl2_deploy"
	"trackness/sentinel"
	"trackness/splitwiser"
	"getndazn/dazn-cli"
	"getndazn/sre-grafana"
)

wsl2_config
git_config
update_distro
update_shell
install_dev_tools
git_clone_all "$code_dir" "${github_repos[@]}"

code .
exec zsh
